<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ§  MySQL Procedures Dashboard (5 Custom Reports)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-secondary text-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">ðŸ§  MySQL Procedures Dashboard (5 Custom Reports)</h2>

    <div class="card bg-dark p-4 shadow">
      <select id="procedureSelect" class="form-select mb-3"></select>
      <div id="paramInputs" class="mb-3"></div>
      <button id="executeBtn" class="btn btn-warning w-100 mb-3">âš¡ Execute Procedure</button>
      
      <div id="resultErrorBox" class="alert text-center fw-bold mt-3" style="display:none;"></div>
      
      <div id="resultTableBox" class="mt-4" style="display:none;">
          <p class="fw-bold text-info">Results:</p>
          <div class="table-responsive">
              <table id="resultTable" class="table table-striped table-bordered table-sm table-dark"></table>
          </div>
      </div>
    </div>
  </div>

  <script>
    function renderTable(containerId, data) {
        const table = document.getElementById(containerId);
        if (data.length === 0) {
            table.innerHTML = '<tbody><tr><td>No results found.</td></tr></tbody>';
            return;
        }
        const headers = Object.keys(data[0]);
        const headerRow = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        const bodyRows = data.map(row => `<tr>${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}</tr>`).join('');
        table.innerHTML = headerRow + `<tbody>${bodyRows}</tbody>`;
    }

    async function loadProcedures() {
      const res = await fetch('/api/procedures');
      const data = await res.json(); 
      const select = document.getElementById('procedureSelect');
      select.innerHTML = data.map(p => `<option value="${p}">${p}</option>`).join('');
      if (data.length) loadProcedureInfo(data[0]);
    }

    async function loadProcedureInfo(procName) {
      const res = await fetch(`/api/procedure_info/${procName}`);
      const info = await res.json();
      const inputDiv = document.getElementById('paramInputs');
      if (info.error) {
        inputDiv.innerHTML = `<div class='text-danger'>${info.error}</div>`;
        return;
      }
      inputDiv.innerHTML = (info.params.length > 0 ?
        `<p class='small text-warning'>Enter values for the following parameters:</p>` :
        `<p class='small text-warning'>This procedure takes no parameters. The query will run immediately.</p>`) +
        info.params.map(p =>
          `<input id='param_${p.PARAMETER_NAME}' class='form-control mb-2' placeholder='Enter ${p.PARAMETER_NAME} (${p.DATA_TYPE})'>`
        ).join('');
    }

    async function executeProcedure() {
      const procName = document.getElementById('procedureSelect').value;
      const infoRes = await fetch(`/api/procedure_info/${procName}`);
      const info = await infoRes.json();
      const args = info.params.map(p => document.getElementById(`param_${p.PARAMETER_NAME}`).value);
      const errorBox = document.getElementById('resultErrorBox');
      const tableBox = document.getElementById('resultTableBox');
      tableBox.style.display = 'none';
      errorBox.style.display = 'block';
      errorBox.className = 'alert alert-info';
      errorBox.textContent = 'â³ Executing...';

      const response = await fetch('/api/execute_procedure', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ procedure: procName, args })
      });
      const data = await response.json();
      if (data.error) {
        errorBox.className = 'alert alert-danger';
        errorBox.textContent = `âŒ ${data.error}`;
        tableBox.style.display = 'none';
      } else {
        const results = data.result;
        if (results.length > 0) {
            renderTable('resultTable', results);
            errorBox.style.display = 'none';
            tableBox.style.display = 'block';
        } else {
            errorBox.className = 'alert alert-success';
            errorBox.textContent = 'âœ… Procedure executed successfully. No rows returned.';
            tableBox.style.display = 'none';
        }
      }
    }

    document.getElementById('procedureSelect').addEventListener('change', e => loadProcedureInfo(e.target.value));
    document.getElementById('executeBtn').addEventListener('click', executeProcedure);

    loadProcedures();
  </script>
</body>
</html>
