<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üé• BookMyShow Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div class="container py-4">
    <h1 class="text-center mb-4">üé¨ Unified Dashboard</h1>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#movies">üéûÔ∏è Movies</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#functions">‚öôÔ∏è Functions</button></li>
    </ul>

    <div class="tab-content">
        <!-- MOVIE TAB -->
        <div class="tab-pane fade show active" id="movies">
            <div class="card p-3 shadow-sm mb-3">
                <div class="row g-2">
                    <div class="col-md-3"><label>Genre</label>
                        <select id="genre" class="form-select"><option>All</option>{% for g in options.genres %}<option>{{ g }}</option>{% endfor %}</select>
                    </div>
                    <div class="col-md-3"><label>Language</label>
                        <select id="language" class="form-select"><option>All</option>{% for l in options.languages %}<option>{{ l }}</option>{% endfor %}</select>
                    </div>
                    <div class="col-md-3"><label>Search Title</label>
                        <input id="search" class="form-control" placeholder="Enter movie name...">
                    </div>
                    <div class="col-md-2"><label>Sort</label>
                        <select id="sort" class="form-select"><option>Latest Releases</option><option>Top Rated</option><option>A-Z</option></select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end"><button id="applyFilters" class="btn btn-primary w-100">Apply</button></div>
                </div>
            </div>

            <table class="table table-striped">
                <thead><tr><th>Title</th><th>Genre</th><th>Language</th><th>Rating</th><th>Release Date</th></tr></thead>
                <tbody id="movieTable"></tbody>
            </table>

            <div class="text-center mt-3">
                <button id="prevPage" class="btn btn-secondary">Prev</button>
                <span id="pageIndicator" class="mx-2"></span>
                <button id="nextPage" class="btn btn-secondary">Next</button>
            </div>
        </div>

        <!-- FUNCTION TAB -->
        <div class="tab-pane fade" id="functions">
            <div class="card p-4 bg-dark text-light shadow">
                <h3 class="text-center mb-3">‚öôÔ∏è MySQL Functions Dashboard</h3>
                <select id="functionSelect" class="form-select mb-3">
                    <option value="">-- Select Function --</option>
                    {% for f in options.functions %}
                        <option value="{{ f }}">{{ f }}</option>
                    {% endfor %}
                </select>

                <div id="functionDescription" class="mb-3 small text-warning"></div>
                <div id="paramInputs" class="mb-3"></div>
                <button id="executeBtn" class="btn btn-primary w-100">üöÄ Execute Function</button>
                <div id="resultBox" class="alert mt-4 text-center fw-bold" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentPage = 1;

// --- Movie Section ---
async function fetchMovies() {
  const filters = {
    genre: genre.value, language: language.value,
    search: search.value, sort: sort.value, page: currentPage
  };
  const res = await fetch("/api/movies", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(filters)});
  const data = await res.json();
  const table = document.getElementById("movieTable");
  table.innerHTML = data.movies.map(m => `<tr>
    <td>${m.title}</td><td>${m.genre}</td><td>${m.language}</td><td>${m.rating}</td><td>${m.release_date}</td></tr>`).join("");
  pageIndicator.textContent = `Page ${currentPage}`;
}
applyFilters.onclick = ()=>{currentPage=1;fetchMovies();};
prevPage.onclick = ()=>{if(currentPage>1){currentPage--;fetchMovies();}};
nextPage.onclick = ()=>{currentPage++;fetchMovies();};
fetchMovies();

// --- Functions Section ---
async function loadFunctionInfo(funcName) {
  if (!funcName) return;
  const res = await fetch(`/api/function_info/${funcName}`);
  const info = await res.json();
  const descDiv = document.getElementById("functionDescription");
  const inputDiv = document.getElementById("paramInputs");
  descDiv.innerHTML = info.error ? `<span class='text-danger'>${info.error}</span>` :
    `<strong>Description:</strong> ${info.description}<br><strong>Parameters:</strong> ${info.params.length ? info.params.join(", ") : "None"}`;
  inputDiv.innerHTML = info.params.map(p=>`<input class='form-control mb-2' id='param_${p}' placeholder='Enter ${p} here'>`).join("");
}

functionSelect.onchange = e => loadFunctionInfo(e.target.value);

executeBtn.onclick = async ()=>{
  const funcName = functionSelect.value;
  if(!funcName) return;
  const res = await fetch(`/api/function_info/${funcName}`);
  const info = await res.json();
  const args = info.params.map(p=>document.getElementById(`param_${p}`).value);
  resultBox.style.display='block';
  resultBox.className='alert alert-info';
  resultBox.textContent='‚è≥ Executing...';
  const response = await fetch('/api/execute_function',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({function:funcName,args})});
  const data = await response.json();
  if(data.result!==undefined){resultBox.className='alert alert-success';resultBox.textContent=`‚úÖ Result: ${data.result}`;}
  else{resultBox.className='alert alert-danger';resultBox.textContent=`‚ùå ${data.error}`;}
};
</script>
</body>
</html>
