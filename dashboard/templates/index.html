<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé• BookMyShow Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div class="container py-4">
  <h1 class="text-center mb-4">üé¨ BookMyShow Dashboard</h1>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#movies">üéûÔ∏è All Movies</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#operations">‚öôÔ∏è Operations</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#views">üìä Insights</button></li>
  </ul>

  <div class="tab-content">

    <!-- MOVIES TAB (Unchanged) -->
    <div class="tab-pane fade show active" id="movies">
      <div class="card p-3 shadow-sm mb-3">
        <div class="row g-2">
          <div class="col-md-3"><label>Genre</label>
            <select id="genre" class="form-select"><option>All</option>{% for g in options.genres %}<option>{{ g }}</option>{% endfor %}</select>
          </div>
          <div class="col-md-3"><label>Language</label>
            <select id="language" class="form-select"><option>All</option>{% for l in options.languages %}<option>{{ l }}</option>{% endfor %}</select>
          </div>
          <div class="col-md-3"><label>Search Title</label>
            <input id="search" class="form-control" placeholder="Enter movie name...">
          </div>
          <div class="col-md-2"><label>Sort</label>
            <select id="sort" class="form-select"><option>Latest Releases</option><option>Top Rated</option><option>A-Z</option></select>
          </div>
          <div class="col-md-1 d-flex align-items-end"><button id="applyFilters" class="btn btn-primary w-100">Apply</button></div>
        </div>
      </div>

      <table class="table table-striped">
        <thead><tr><th>Title</th><th>Genre</th><th>Language</th><th>Rating</th><th>Release Date</th></tr></thead>
        <tbody id="movieTable"></tbody>
      </table>

      <div class="text-center mt-3">
        <button id="prevPage" class="btn btn-secondary">Prev</button>
        <span id="pageIndicator" class="mx-2"></span>
        <button id="nextPage" class="btn btn-secondary">Next</button>
      </div>
    </div>

    <!-- UNIFIED OPERATIONS TAB (Functions & Procedures) -->
    <div class="tab-pane fade" id="operations">
      <div class="card p-4 bg-dark text-light shadow">
        <h3 class="text-center mb-3 text-info">‚öôÔ∏è Database Operations (Functions & Procedures)</h3>
        <select id="operationSelect" class="form-select mb-3">
          <option value="">-- Select --</option>
          {% for op in options.operations %}
            <option value="{{ op }}">{{ op }}</option>
          {% endfor %}
        </select>

        <div id="operationDescription" class="mb-3 small text-warning"></div>
        <div id="paramInputs" class="mb-3"></div>
        
        <button id="executeOpBtn" class="btn btn-primary w-100">üöÄ Execute Operation</button>

        <!-- Scalar/Error Output -->
        <div id="scalarResultBox" class="alert mt-4 text-center fw-bold" style="display:none;"></div>
        
        <!-- Tabular Output (For Procedures) -->
        <div id="tabularResultBox" class="mt-4" style="display:none;">
            <p class="fw-bold text-info">Results:</p>
            <div class="table-responsive">
                <table id="tabularResultTable" class="table table-striped table-bordered table-sm table-dark"></table>
            </div>
        </div>
      </div>
    </div>

    <!-- VIEWS TAB (Tab ID changed from #views to #insights, content retained) -->
    <div class="tab-pane fade" id="views">
      <div class="card p-4 bg-dark text-light shadow">
        <h3 class="text-center mb-3 text-info">üìä Insights Panel</h3>
        <select id="viewSelect" class="form-select mb-3">
          <option value="">-- Select --</option>
          {% for v in options.views %}
            <option value="{{ v }}">{{ v }}</option>
          {% endfor %}
        </select>
        <button id="executeViewBtn" class="btn btn-info w-100 mb-3">üîç Get Insights</button>
        
        <div id="viewErrorBox" class="alert mt-4 text-center fw-bold" style="display:none;"></div>
        
        <div id="viewResultBox" class="mt-4" style="display:none;">
            <p class="fw-bold text-info">Results:</p>
            <div class="table-responsive">
                <table id="viewResultTable" class="table table-striped table-bordered table-sm table-dark"></table>
            </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- UTILITY FUNCTION TO RENDER TABLE ---
function renderTable(containerId, data) {
    const table = document.getElementById(containerId);
    // Use the first row to determine headers
    if (data.length === 0) {
        table.innerHTML = '<tbody><tr><td>No results found.</td></tr></tbody>';
        return;
    }
    const headers = Object.keys(data[0]);
    const headerRow = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
    const bodyRows = data.map(row => `<tr>${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}</tr>`).join('');
    table.innerHTML = headerRow + `<tbody>${bodyRows}</tbody>`;
}

// --- MOVIES (Unchanged) ---
let currentPage = 1;
async function fetchMovies() {
  const filters = {
    genre: genre.value, language: language.value,
    search: search.value, sort: sort.value, page: currentPage
  };
  const res = await fetch("/api/movies", {
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(filters)
  });
  const data = await res.json();
  const table = document.getElementById("movieTable");
  table.innerHTML = data.movies.map(m => `<tr>
    <td>${m.title}</td><td>${m.genre}</td><td>${m.language}</td><td>${m.rating}</td><td>${m.release_date}</td></tr>`).join("");
  pageIndicator.textContent = `Page ${currentPage}`;
}
applyFilters.onclick = ()=>{currentPage=1;fetchMovies();};
prevPage.onclick = ()=>{if(currentPage>1){currentPage--;fetchMovies();}};
nextPage.onclick = ()=>{currentPage++;fetchMovies();};
fetchMovies();


// --- UNIFIED OPERATIONS (Functions & Procedures) ---
let currentOperationType = ''; // To store the type (FUNCTION or PROCEDURE) for execution

async function loadOperationInfo(opName) {
  if (!opName) return;
  
  // Clear previous results
  document.getElementById('tabularResultBox').style.display = 'none';
  document.getElementById('scalarResultBox').style.display = 'none';

  const res = await fetch(`/api/operation_info/${opName}`);
  const info = await res.json();
  const descDiv = document.getElementById("operationDescription");
  const inputDiv = document.getElementById("paramInputs");
  
  if (info.error) {
    descDiv.innerHTML = `<span class='text-danger'>${info.error}</span>`;
    inputDiv.innerHTML = "";
    currentOperationType = '';
    return;
  }
  
  // Store the type
  currentOperationType = info.type;

  // Display description and type
  descDiv.innerHTML = `
    <span class="badge bg-warning text-dark">${info.type}</span>
    <strong>Description:</strong> ${info.description}<br>
    <strong>Parameters:</strong> ${info.params.length ? info.params.join(", ") : "None"}
  `;

  // Generate input fields
  inputDiv.innerHTML = info.params.map(p => {
      const typeHint = info.input_types ? ` (${info.input_types[p]})` : '';
      return `<input class='form-control mb-2' id='param_${p}' placeholder='Enter ${p}${typeHint}'>`;
  }).join("");
}

operationSelect.onchange = e => loadOperationInfo(e.target.value);

executeOpBtn.onclick = async ()=>{
  const opName = operationSelect.value;
  if(!opName || !currentOperationType) return;
  
  // Fetch parameters based on the current selection to build arguments array
  const infoRes = await fetch(`/api/operation_info/${opName}`);
  const info = await infoRes.json();
  const args = info.params.map(p=>document.getElementById(`param_${p}`).value);
  
  const scalarBox = document.getElementById('scalarResultBox');
  const tabularBox = document.getElementById('tabularResultBox');
  
  scalarBox.style.display='block';
  tabularBox.style.display='none';
  scalarBox.className='alert alert-info';
  scalarBox.textContent='‚è≥ Executing...';

  const response = await fetch('/api/execute_operation',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({operation:opName, type:currentOperationType, args})
  });
  const data = await response.json();
  
  if(data.error){
    scalarBox.className='alert alert-danger';
    scalarBox.textContent=`‚ùå ${data.error}`;
  } else if (data.type === 'FUNCTION') {
    // Handle Function Result (Scalar)
    scalarBox.className='alert alert-success';
    scalarBox.textContent=`‚úÖ Result: ${data.result}`;
  } else if (data.type === 'PROCEDURE') {
    // Handle Procedure Result (Tabular)
    if (data.result && data.result.length > 0) {
        renderTable('tabularResultTable', data.result);
        scalarBox.style.display = 'none';
        tabularBox.style.display = 'block';
    } else {
        scalarBox.className = 'alert alert-success';
        scalarBox.textContent = '‚úÖ Procedure executed successfully. No rows returned.';
    }
  }
};


// --- VIEWS (Unchanged logic) ---
document.getElementById('executeViewBtn').onclick = async () => {
  const viewName = document.getElementById('viewSelect').value;
  if (!viewName) return;
  const resultBox = document.getElementById('viewResultBox');
  const errorBox = document.getElementById('viewErrorBox');
  resultBox.style.display = 'none';
  errorBox.style.display = 'block';
  errorBox.className = 'alert alert-info';
  errorBox.textContent = `‚è≥ Querying view: ${viewName}...`;

  try {
    const response = await fetch('/api/execute_view', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ view: viewName })
    });
    const data = await response.json();

    if (data.error) {
      errorBox.className = 'alert alert-danger';
      errorBox.textContent = `‚ùå Error executing view: ${data.error}`;
      return;
    }

    // Convert array of arrays (from non-dictionary cursor) to array of objects for renderTable
    const tabularData = data.data.map(row => {
        const rowObj = {};
        data.headers.forEach((header, index) => { rowObj[header] = row[index]; });
        return rowObj;
    });

    if (tabularData.length > 0) {
        renderTable('viewResultTable', tabularData);
        errorBox.style.display = 'none';
        resultBox.style.display = 'block';
    } else {
      errorBox.className = 'alert alert-warning';
      errorBox.textContent = `‚ö†Ô∏è View ${viewName} executed successfully but returned no rows.`;
      resultBox.style.display = 'none';
    }

  } catch (e) {
    errorBox.className = 'alert alert-danger';
    errorBox.textContent = `‚ùå Network error: ${e.message}`;
    resultBox.style.display = 'none';
  }
};
</script>
</body>
</html>
