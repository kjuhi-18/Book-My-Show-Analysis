<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé• BookMyShow Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div class="container py-4">
  <h1 class="text-center mb-4">üé¨ Unified Dashboard</h1>

  <!-- Tabs (Views Tab Added) -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#movies">üéûÔ∏è Movies</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#functions">‚öôÔ∏è Functions</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#procedures">üß† Procedures</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#views">üìä Views</button></li> <!-- New Tab -->
  </ul>

  <div class="tab-content">

    <!-- MOVIES TAB -->
    <div class="tab-pane fade show active" id="movies">
      <div class="card p-3 shadow-sm mb-3">
        <div class="row g-2">
          <div class="col-md-3"><label>Genre</label>
            <select id="genre" class="form-select"><option>All</option>{% for g in options.genres %}<option>{{ g }}</option>{% endfor %}</select>
          </div>
          <div class="col-md-3"><label>Language</label>
            <select id="language" class="form-select"><option>All</option>{% for l in options.languages %}<option>{{ l }}</option>{% endfor %}</select>
          </div>
          <div class="col-md-3"><label>Search Title</label>
            <input id="search" class="form-control" placeholder="Enter movie name...">
          </div>
          <div class="col-md-2"><label>Sort</label>
            <select id="sort" class="form-select"><option>Latest Releases</option><option>Top Rated</option><option>A-Z</option></select>
          </div>
          <div class="col-md-1 d-flex align-items-end"><button id="applyFilters" class="btn btn-primary w-100">Apply</button></div>
        </div>
      </div>

      <table class="table table-striped">
        <thead><tr><th>Title</th><th>Genre</th><th>Language</th><th>Rating</th><th>Release Date</th></tr></thead>
        <tbody id="movieTable"></tbody>
      </table>

      <div class="text-center mt-3">
        <button id="prevPage" class="btn btn-secondary">Prev</button>
        <span id="pageIndicator" class="mx-2"></span>
        <button id="nextPage" class="btn btn-secondary">Next</button>
      </div>
    </div>

    <!-- FUNCTIONS TAB -->
    <div class="tab-pane fade" id="functions">
      <div class="card p-4 bg-dark text-light shadow">
        <h3 class="text-center mb-3">‚öôÔ∏è MySQL Functions Dashboard</h3>
        <select id="functionSelect" class="form-select mb-3">
          <option value="">-- Select Function --</option>
          {% for f in options.functions %}
            <option value="{{ f }}">{{ f }}</option>
          {% endfor %}
        </select>

        <div id="functionDescription" class="mb-3 small text-warning"></div>
        <div id="paramInputs" class="mb-3"></div>
        <button id="executeBtn" class="btn btn-primary w-100">üöÄ Execute Function</button>
        <div id="resultBox" class="alert mt-4 text-center fw-bold" style="display:none;"></div>
      </div>
    </div>

    <!-- PROCEDURES TAB -->
    <div class="tab-pane fade" id="procedures">
      <div class="card p-4 bg-secondary text-light shadow">
        <h3 class="text-center mb-3">üß† MySQL Procedures Dashboard</h3>
        <select id="procedureSelect" class="form-select mb-3">
          <option value="">-- Select Procedure --</option>
          {% for p in options.procedures %}
            <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>

        <div id="procedureInputs" class="mb-3"></div>
        <button id="executeProcBtn" class="btn btn-warning w-100 mb-3">‚ö° Execute Procedure</button>
        <div id="procedureResultBox" class="alert text-center fw-bold" style="display:none;"></div>
      </div>
    </div>

    <!-- VIEWS TAB (NEW) -->
    <div class="tab-pane fade" id="views">
      <div class="card p-4 bg-dark text-light shadow">
        <h3 class="text-center mb-3 text-info">üìä MySQL Views Dashboard</h3>
        <select id="viewSelect" class="form-select mb-3">
          <option value="">-- Select View --</option>
          {% for v in options.views %}
            <option value="{{ v }}">{{ v }}</option>
          {% endfor %}
        </select>
        <button id="executeViewBtn" class="btn btn-info w-100 mb-3">üîç Query View</button>
        
        <div id="viewErrorBox" class="alert mt-4 text-center fw-bold" style="display:none;"></div>
        
        <div id="viewResultBox" class="mt-4" style="display:none;">
            <p class="fw-bold text-info">Results:</p>
            <div class="table-responsive">
                <!-- Use table-dark for better contrast on a dark card -->
                <table id="viewResultTable" class="table table-striped table-bordered table-sm table-dark"></table>
            </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- MOVIES ---
let currentPage = 1;
async function fetchMovies() {
  const filters = {
    genre: genre.value, language: language.value,
    search: search.value, sort: sort.value, page: currentPage
  };
  const res = await fetch("/api/movies", {
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(filters)
  });
  const data = await res.json();
  const table = document.getElementById("movieTable");
  table.innerHTML = data.movies.map(m => `<tr>
    <td>${m.title}</td><td>${m.genre}</td><td>${m.language}</td><td>${m.rating}</td><td>${m.release_date}</td></tr>`).join("");
  pageIndicator.textContent = `Page ${currentPage}`;
}
applyFilters.onclick = ()=>{currentPage=1;fetchMovies();};
prevPage.onclick = ()=>{if(currentPage>1){currentPage--;fetchMovies();}};
nextPage.onclick = ()=>{currentPage++;fetchMovies();};
fetchMovies();


// --- FUNCTIONS ---
async function loadFunctionInfo(funcName) {
  if (!funcName) return;
  const res = await fetch(`/api/function_info/${funcName}`);
  const info = await res.json();
  const descDiv = document.getElementById("functionDescription");
  const inputDiv = document.getElementById("paramInputs");
  descDiv.innerHTML = info.error ? `<span class='text-danger'>${info.error}</span>` :
    `<strong>Description:</strong> ${info.description}<br><strong>Parameters:</strong> ${info.params.length ? info.params.join(", ") : "None"}`;
  inputDiv.innerHTML = info.params.map(p=>`<input class='form-control mb-2' id='param_${p}' placeholder='Enter ${p} here'>`).join("");
}
functionSelect.onchange = e => loadFunctionInfo(e.target.value);

executeBtn.onclick = async ()=>{
  const funcName = functionSelect.value;
  if(!funcName) return;
  const res = await fetch(`/api/function_info/${funcName}`);
  const info = await res.json();
  const args = info.params.map(p=>document.getElementById(`param_${p}`).value);
  resultBox.style.display='block';
  resultBox.className='alert alert-info';
  resultBox.textContent='‚è≥ Executing...';
  const response = await fetch('/api/execute_function',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({function:funcName,args})});
  const data = await response.json();
  if(data.result!==undefined){resultBox.className='alert alert-success';resultBox.textContent=`‚úÖ Result: ${data.result}`;}
  else{resultBox.className='alert alert-danger';resultBox.textContent=`‚ùå ${data.error}`;}
};


// --- PROCEDURES ---
async function loadProcedureInfo(procName) {
  if (!procName) return;
  const res = await fetch(`/api/procedure_info/${procName}`);
  const info = await res.json();
  const inputDiv = document.getElementById("procedureInputs");
  if (info.error) {
    inputDiv.innerHTML = `<div class='text-danger'>${info.error}</div>`;
    return;
  }
  // Added a description based on whether params are present or not
  inputDiv.innerHTML = (info.params.length > 0 ?
    `<p class='small text-warning'>Enter values for the following parameters:</p>` :
    `<p class='small text-warning'>This procedure takes no parameters.</p>`) +
    info.params.map(p =>
      `<input id='proc_${p.PARAMETER_NAME}' class='form-control mb-2' placeholder='Enter ${p.PARAMETER_NAME} (${p.DATA_TYPE})'>`
    ).join("");
}
procedureSelect.onchange = e => loadProcedureInfo(e.target.value);

executeProcBtn.onclick = async ()=>{
  const procName = procedureSelect.value;
  if(!procName) return;
  
  const infoRes = await fetch(`/api/procedure_info/${procName}`);
  const info = await infoRes.json();
  
  // Collect arguments from dynamically generated inputs
  const args = info.params.map(p=>document.getElementById(`proc_${p.PARAMETER_NAME}`).value);
  
  const box = document.getElementById('procedureResultBox');
  box.style.display='block'; box.className='alert alert-info'; box.textContent='‚è≥ Executing...';
  const response = await fetch('/api/execute_procedure',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({procedure:procName,args})});
  const data = await response.json();
  
  if(data.error){box.className='alert alert-danger';box.textContent=`‚ùå ${data.error}`;}
  else{box.className='alert alert-success';box.textContent=`‚úÖ Result (Rows Affected/Returned): ${JSON.stringify(data.result)}`;}
};


// --- VIEWS (NEW) ---
document.getElementById('executeViewBtn').onclick = async () => {
  const viewName = document.getElementById('viewSelect').value;
  if (!viewName) return;

  const resultBox = document.getElementById('viewResultBox');
  const errorBox = document.getElementById('viewErrorBox');
  const resultTable = document.getElementById('viewResultTable');

  resultBox.style.display = 'none';
  errorBox.style.display = 'block';
  errorBox.className = 'alert alert-info';
  errorBox.textContent = `‚è≥ Querying view: ${viewName}...`;

  try {
    const response = await fetch('/api/execute_view', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ view: viewName })
    });

    const data = await response.json();

    if (data.error) {
      errorBox.className = 'alert alert-danger';
      errorBox.textContent = `‚ùå Error executing view: ${data.error}`;
      return;
    }

    // Build the table
    if (data.headers && data.data) {
      // Create table header
      const headerRow = `<thead><tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;

      // Create table body
      const bodyRows = data.data.map(row =>
        // Safely stringify and escape cell data, handle nulls
        `<tr>${row.map(cell => `<td>${cell !== null ? cell : ''}</td>`).join('')}</tr>`
      ).join('');

      resultTable.innerHTML = headerRow + `<tbody>${bodyRows}</tbody>`;
      errorBox.style.display = 'none';
      resultBox.style.display = 'block';

      if (data.data.length === 0) {
        errorBox.style.display = 'block';
        errorBox.className = 'alert alert-warning';
        errorBox.textContent = `‚ö†Ô∏è View ${viewName} executed successfully, but returned no rows.`;
      }
    }
  } catch (e) {
    errorBox.className = 'alert alert-danger';
    errorBox.textContent = `‚ùå A network error occurred: ${e.message}`;
    resultBox.style.display = 'none';
  }
};
</script>
</body>
</html>
